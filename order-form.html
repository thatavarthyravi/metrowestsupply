<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Order | Unit Turn Supply</title>
    <link rel="stylesheet" href="newstyles.css">
    <style>
        body { background-color: #f4f7f9; font-family: sans-serif; line-height: 1.6; }
        .order-container { max-width: 900px; margin: 40px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .form-header { text-align: center; margin-bottom: 30px; }
        
        /* The Selection Menu */
        .selection-box { background: #fdfdfd; padding: 25px; border: 2px solid var(--navy); border-radius: 8px; margin-bottom: 25px; }
        .bundle-group { margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .bundle-group:last-child { border-bottom: none; }
        .bundle-group h3 { color: var(--navy); margin-bottom: 10px; font-size: 1.1rem; }
        
        .category-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 10px 15px; border: 1px solid #ddd; 
            border-radius: 6px; margin-bottom: 8px; transition: 0.2s;
        }
        .category-row:hover { border-color: var(--orange); background: #fffcf9; }
        .cat-info { flex: 2; }
        .cat-info strong { display: block; color: #333; }
        .cat-info span { font-size: 0.8rem; color: #777; }
        
        .cat-actions { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .qty-mini { width: 50px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        .btn-add-sm { background: var(--orange); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        
        /* Cart Summary */
        #cart-container { margin: 25px 0; padding: 20px; background: #fff; border: 2px solid var(--orange); border-radius: 8px; }
        #cart-list { list-style: none; padding: 0; margin: 0; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        #total-badge { background: var(--orange); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }

        #success-message { display: none; text-align: center; padding: 40px; }
        @media (max-width: 600px) { .category-row { flex-direction: column; align-items: flex-start; } .cat-actions { width: 100%; margin-top: 10px; } }
    </style>
</head>
<body>

    <div class="order-container">
        <div class="form-header" id="form-header">
            <h1>Customize Your Turn Kit</h1>
            <p>Pick and choose the specific modules you need from our bundles.</p>
        </div>

        <form id="orderForm" action="https://formspree.io/f/xlggeeog" method="POST">
            
            <div class="selection-box">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <label style="font-weight: bold; color: var(--navy);">Menu: Select Modules</label>
                    <a href="new-bundles.html" target="_blank" style="font-size: 0.8rem; color: var(--orange);">Review Item Details</a>
                </div>

                <div id="bundle-menu-container">
                    <!-- JavaScript will inject Bundle 1, 2, and 3 categories here -->
                    <p style="text-align:center;">Loading modules...</p>
                </div>
                
                <p id="limit-warning" style="display:none; color: #cc0000; font-size: 0.85rem; font-weight: bold; margin-top: 15px;">
                    ⚠️ Online limit is 10 modules. Please call for bulk orders.
                </p>
            </div>

            <div id="cart-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label style="font-weight: bold; color: var(--navy);">Your Custom Kit Summary</label>
                    <span id="total-badge">0 Modules</span>
                </div>
                <ul id="cart-list"></ul>
                <input type="hidden" name="custom_kit_list" id="final-order-input" required>
            </div>

            <!-- Contact/Shipping Details -->
            <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div class="form-group" style="flex:1;"><label>Name</label><input type="text" name="name" required></div>
                <div class="form-group" style="flex:1;"><label>Company</label><input type="text" name="company" required></div>
            </div>
            <div class="form-group" style="margin-bottom: 15px;"><label>Delivery Address</label><textarea name="address" rows="2" required></textarea></div>
            <div class="form-group" style="margin-bottom: 15px;"><label>Email</label><input type="email" name="_replyto" required></div>
            <div class="form-group"><label>Notes</label><textarea name="notes" rows="2" placeholder="Any extra items or instructions..."></textarea></div>

            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" id="submit-btn" class="btn-orange" style="width: 100%; font-size: 1.2rem;">Submit Order Request</button>
            </div>
        </form>

        <div id="success-message">
            <div style="font-size: 4rem; margin-bottom: 20px;">✅</div>
            <h2>Order Sent Successfully!</h2>
            <p>We'll email your custom invoice and delivery ETA shortly.</p>
            <a href="index.html" class="btn-orange" style="text-decoration: none; display: inline-block; margin-top: 20px;">Return Home</a>
        </div>
    </div>

    <script>
        const menuContainer = document.getElementById('bundle-menu-container');
        const cartList = document.getElementById('cart-list');
        const cartContainer = document.getElementById('cart-container');
        const finalInput = document.getElementById('final-order-input');
        const totalBadge = document.getElementById('total-badge');
        const limitWarning = document.getElementById('limit-warning');
        const form = document.getElementById('orderForm');

        let cart = [];
        const MAX_TOTAL = 10;

        // 1. FETCH AND BUILD THE MENU
        fetch('data/miniproductbundles.json')
            .then(res => res.json())
            .then(data => {
                menuContainer.innerHTML = ''; // Clear loader
                data.bundles.forEach(bundle => {
                    const group = document.createElement('div');
                    group.className = 'bundle-group';
                    group.innerHTML = `<h3>${bundle.name}</h3>`;
                    
                    bundle.categories.forEach(cat => {
                        const row = document.createElement('div');
                        row.className = 'category-row';
                        const estPrice = cat.items.reduce((s, i) => s + (i.typical_quantity * i.unit_cost_estimate), 0);
                        
                        row.innerHTML = `
                            <div class="cat-info">
                                <strong>${cat.category}</strong>
                                <span>Est. $${estPrice.toFixed(2)} | ${cat.items.length} item types</span>
                            </div>
                            <div class="cat-actions">
                                <input type="number" value="1" min="1" max="10" class="qty-mini" id="qty-${cat.category.replace(/\s+/g, '')}">
                                <button type="button" class="btn-add-sm" onclick="addToCart('${cat.category}', '${bundle.bundle_id}', '${cat.category.replace(/\s+/g, '')}')">+ Add</button>
                            </div>
                        `;
                        group.appendChild(row);
                    });
                    menuContainer.appendChild(group);
                });
            });

        // 2. CART FUNCTIONS
        window.addToCart = (catName, bundleId, inputId) => {
            const qty = parseInt(document.getElementById('qty-' + inputId).value);
            let currentTotal = cart.reduce((sum, item) => sum + item.qty, 0);

            if (currentTotal + qty > MAX_TOTAL) {
                limitWarning.style.display = 'block';
                return;
            }

            limitWarning.style.display = 'none';
            cart.push({ name: catName, bundle: bundleId, qty: qty });
            renderCart();
        };

        function renderCart() {
            cartList.innerHTML = '';
            let total = 0;
            let summary = "";
            cart.forEach((item, index) => {
                total += item.qty;
                summary += `${item.qty}x ${item.name} (${item.bundle}) | `;
                const li = document.createElement('li');
                li.className = 'cart-item';
                li.innerHTML = `<span><strong>${item.qty}x</strong> ${item.name} <small>(${item.bundle})</small></span>
                                <button type="button" onclick="removeItem(${index})" style="color:red;border:none;background:none;cursor:pointer;">Remove</button>`;
                cartList.appendChild(li);
            });
            cartContainer.style.display = cart.length ? 'block' : 'none';
            totalBadge.innerText = `${total} Modules`;
            finalInput.value = summary;
        }

        window.removeItem = (index) => { cart.splice(index, 1); renderCart(); };

        // 3. SUBMISSION
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            if (!cart.length) { alert("Please add at least one module."); return; }
            const btn = document.getElementById("submit-btn");
            btn.innerText = "Sending Request...";
            btn.disabled = true;
            fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'Accept': 'application/json' } })
                .then(res => { if (res.ok) { 
                    form.style.display = "none"; 
                    document.getElementById("form-header").style.display = "none"; 
                    document.getElementById("success-message").style.display = "block"; 
                    window.scrollTo(0,0); 
                } });
        });
    </script>
</body>
</html>
