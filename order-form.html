<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Order Form | Unit Turn Supply</title>
    <link rel="stylesheet" href="newstyles.css">
    <style>
        body { background-color: #f4f7f9; font-family: sans-serif; line-height: 1.6; }
        .order-container { max-width: 950px; margin: 40px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Section Styling */
        .order-section { margin-bottom: 40px; }
        .section-title { background: var(--navy); color: white; padding: 15px; border-radius: 8px 8px 0 0; margin: 0; font-size: 1.2rem; }
        .selection-area { border: 2px solid var(--navy); border-radius: 0 0 8px 8px; padding: 20px; background: #fdfdfd; }
        
        /* Item Row Styling */
        .item-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 12px 18px; border: 1px solid #ddd; 
            border-radius: 6px; margin-bottom: 10px; transition: 0.2s;
        }
        .item-row:hover { border-color: var(--orange); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .item-info { flex: 2; }
        .item-info strong { display: block; color: var(--navy); font-size: 1rem; }
        .item-info span { font-size: 0.8rem; color: #666; }

        .item-actions { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
        .qty-input { width: 55px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
        
        /* Cart Summary */
        #cart-container { margin: 30px 0; padding: 25px; background: #fff; border: 2px solid var(--orange); border-radius: 8px; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        #total-badge { background: var(--orange); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        #success-message { display: none; text-align: center; padding: 40px; }
        @media (max-width: 768px) { .item-row { flex-direction: column; align-items: flex-start; } .item-actions { width: 100%; margin-top: 10px; } }
    </style>
</head>
<body>

    <div class="order-container">
        <div class="form-header" id="form-header" style="text-align: center; margin-bottom: 30px;">
            <h1>Build Your Order</h1>
            <p>Choose a Complete Kit for convenience or Mix & Match specific modules.</p>
        </div>

        <form id="orderForm" action="https://formspree.io/f/xlggeeog" method="POST">
            
            <!-- SECTION 1: FULL KITS -->
            <div class="order-section">
                <h2 class="section-title">Option A: Complete Unit Turn Kits</h2>
                <div class="selection-area" id="full-kits-container">
                    <p style="text-align: center;">Loading kits...</p>
                </div>
            </div>

            <!-- SECTION 2: SUB-MODULES -->
            <div class="order-section">
                <h2 class="section-title" style="background: #555;">Option B: Individual Sub-Modules</h2>
                <div class="selection-area" id="modules-container">
                    <p style="text-align: center;">Loading modules...</p>
                </div>
            </div>

            <!-- CART SUMMARY -->
            <div id="cart-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label style="font-weight: bold; font-size: 1.1rem;">Order Summary</label>
                    <span id="total-badge">0 Items</span>
                </div>
                <ul id="cart-list" style="list-style: none; padding: 0;"></ul>
                <input type="hidden" name="MASTER_ORDER_LIST" id="final-order-input" required>
            </div>

            <!-- CONTACT DETAILS -->
            <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div class="form-group" style="flex:1;"><label>Contact Name</label><input type="text" name="name" required></div>
                <div class="form-group" style="flex:1;"><label>Company</label><input type="text" name="company" required></div>
            </div>
            <div class="form-group" style="margin-bottom: 15px;"><label>Delivery Address</label><textarea name="address" rows="2" required placeholder="Full jobsite address..."></textarea></div>
            <div class="form-group" style="margin-bottom: 20px;"><label>Email</label><input type="email" name="_replyto" required></div>

            <button type="submit" id="submit-btn" class="btn-orange" style="width: 100%; font-size: 1.3rem; padding: 18px;">Submit Order Request</button>
        </form>

        <div id="success-message">
            <div style="font-size: 4rem;">✅</div>
            <h2>Order Request Received</h2>
            <p>We are processing your custom manifest. Expect an invoice and ETA via email shortly.</p>
            <a href="index.html" class="btn-orange" style="text-decoration: none; display: inline-block; margin-top: 20px;">Return Home</a>
        </div>
    </div>

    <script>
        const fullKitsContainer = document.getElementById('full-kits-container');
        const modulesContainer = document.getElementById('modules-container');
        const cartList = document.getElementById('cart-list');
        const cartContainer = document.getElementById('cart-container');
        const finalInput = document.getElementById('final-order-input');
        const totalBadge = document.getElementById('total-badge');
        const form = document.getElementById('orderForm');

        let cart = [];

        // 1. FETCH BOTH DATA SOURCES
        Promise.all([
            fetch('data/products.json').then(res => res.json()),
            fetch('data/miniproductbundles.json').then(res => res.json())
        ]).then(([productsData, miniData]) => {
            
            // Build Full Kits (Option A)
            fullKitsContainer.innerHTML = '';
            productsData.forEach((kit, index) => {
                createItemRow(fullKitsContainer, kit.name, `$${kit.price_usd}`, `Full SKU: ${kit.sku}`, 'Full Kit');
            });

            // Build Sub-Modules (Option B)
            modulesContainer.innerHTML = '';
            miniData.bundles.forEach(bundle => {
                bundle.categories.forEach(cat => {
                    const price = cat.items.reduce((s, i) => s + (i.typical_quantity * i.unit_cost_estimate), 0);
                    createItemRow(modulesContainer, cat.category, `$${price.toFixed(2)}`, `Part of ${bundle.name}`, 'Module');
                });
            });
        });

        function createItemRow(parent, name, price, subtext, type) {
            const row = document.createElement('div');
            row.className = 'item-row';
            const safeId = name.replace(/\s+/g, '');
            row.innerHTML = `
                <div class="item-info">
                    <strong>${name}</strong>
                    <span>${price} | ${subtext}</span>
                </div>
                <div class="item-actions">
                    <input type="number" value="1" min="1" class="qty-input" id="qty-${safeId}">
                    <button type="button" class="btn-orange" style="margin:0; padding: 8px 15px;" onclick="addToCart('${name}', '${type}', '${safeId}')">+ Add</button>
                </div>
            `;
            parent.appendChild(row);
        }

        // 2. CART FUNCTIONS
        window.addToCart = (name, type, inputId) => {
            const qty = parseInt(document.getElementById('qty-' + inputId).value);
            cart.push({ name, type, qty });
            renderCart();
        };

        function renderCart() {
            cartList.innerHTML = '';
            let total = 0;
            let summary = "";
            cart.forEach((item, index) => {
                total += item.qty;
                summary += `[${item.type}] ${item.qty}x ${item.name} | `;
                const li = document.createElement('li');
                li.className = 'cart-item';
                li.innerHTML = `<span><strong>${item.qty}x</strong> ${item.name} <small style="color: #888;">(${item.type})</small></span>
                                <button type="button" onclick="removeItem(${index})" style="color:red;border:none;background:none;cursor:pointer;font-weight:bold;">✕</button>`;
                cartList.appendChild(li);
            });
            cartContainer.style.display = cart.length ? 'block' : 'none';
            totalBadge.innerText = `${total} Total Units`;
            finalInput.value = summary;
        }

        window.removeItem = (index) => { cart.splice(index, 1); renderCart(); };

        // 3. SUBMISSION
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            if (!cart.length) { alert("Please add at least one item to your order."); return; }
            const btn = document.getElementById("submit-btn");
            btn.innerText = "Sending Request...";
            btn.disabled = true;
            fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'Accept': 'application/json' } })
                .then(res => { if (res.ok) { 
                    form.style.display = "none"; 
                    document.getElementById("form-header").style.display = "none"; 
                    document.getElementById("success-message").style.display = "block"; 
                    window.scrollTo(0,0); 
                } });
        });
    </script>
</body>
</html>
